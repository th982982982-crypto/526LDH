// --- ĐÂY LÀ CODE DÀNH CHO GOOGLE APPS SCRIPT (FILE .gs) ---
// HƯỚNG DẪN:
// 1. Xóa toàn bộ code cũ trong file Mã.gs (Code.gs)
// 2. Dán code này vào.
// 3. Bấm nút "Deploy" (Triển khai) -> "New Deployment" (Bài triển khai mới).
// 4. Chọn loại: "Web App".
// 5. Phần "Who has access" (Ai có quyền truy cập): CHỌN "ANYONE" (BẤT KỲ AI).
// 6. Bấm Deploy.

function doGet(e) {
  return handleRequest(e);
}

function doPost(e) {
  return handleRequest(e);
}

function handleRequest(e) {
  var lock = LockService.getScriptLock();
  var isWriteAction = e && e.parameter && e.parameter.action && e.parameter.action !== 'get_data';
  
  if (isWriteAction) {
    lock.tryLock(10000); 
  }

  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    setupSheets(ss);

    var action = '';
    var data = {};

    if (e.postData && e.postData.contents) {
      try {
        var json = JSON.parse(e.postData.contents);
        action = json.action;
        data = json.data;
      } catch (err) {}
    } else if (e.parameter) {
      action = e.parameter.action;
      if (e.parameter.data) {
        try { data = JSON.parse(e.parameter.data); } catch (err) {}
      }
    }

    var result = {};
    
    if (action === 'get_data' || !action) {
      result = getAllData(ss);
    } 
    else if (action === 'save_transaction') {
      saveTransaction(ss, data);
      result = { status: 'success' };
    }
    else if (action === 'delete_transaction') {
      deleteRow(ss.getSheetByName('Transactions'), data.id);
      result = { status: 'success' };
    }
    else if (action === 'save_setting') {
      updateSetting(ss, data.key, data.value);
      result = { status: 'success' };
    }
    else if (action === 'update_budget') {
      updateSetting(ss, 'budget', data.amount);
      result = { status: 'success' };
    }
    else if (action === 'save_supplier_list') {
      updateSetting(ss, 'suppliers_list', JSON.stringify(data.suppliers));
      result = { status: 'success' };
    }
    else if (action === 'save_material_list') {
      updateSetting(ss, 'materials_list', JSON.stringify(data.materials));
      result = { status: 'success' };
    }
    else if (action === 'save_unit_list') {
      updateSetting(ss, 'units_list', JSON.stringify(data.units));
      result = { status: 'success' };
    }

    return ContentService.createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  } finally {
    if (isWriteAction) lock.releaseLock();
  }
}

function setupSheets(ss) {
  // Thêm cột quantity, unit, unitPrice, supplier, isPaid
  if (!ss.getSheetByName('Transactions')) {
    ss.insertSheet('Transactions').appendRow(['id', 'date', 'amount', 'type', 'category', 'description', 'image', 'quantity', 'unit', 'unitPrice', 'supplier', 'isPaid']);
  } else {
    // Kiểm tra nếu thiếu cột unit (cột I - index 9 trong sheet, index 8 trong array)
    // Code cũ: id, date, amount, type, cat, desc, img, qty, price, supplier, paid
    // Code mới: id, date, amount, type, cat, desc, img, qty, unit, price, supplier, paid
    // Logic này hơi phức tạp để migrate tự động hoàn hảo, người dùng nên thêm cột thủ công nếu giữ data cũ,
    // hoặc code saveTransaction sẽ tự append vào cuối nếu cấu trúc khác. 
    // Ở đây ta giả định saveTransaction sẽ handle việc ghi đè đúng cột.
  }

  if (!ss.getSheetByName('Settings')) {
    var sSheet = ss.insertSheet('Settings');
    sSheet.appendRow(['key', 'value']);
    sSheet.appendRow(['budget', '0']);
    sSheet.appendRow(['admin_user', 'admin']);
    sSheet.appendRow(['admin_pass', 'Voi123']);
    sSheet.appendRow(['suppliers_list', '["Xuân Chí"]']);
    sSheet.appendRow(['materials_list', '["Cát", "Đá", "Xi măng", "Sắt", "Thép"]']);
    sSheet.appendRow(['units_list', '["m3", "Xe", "Bao", "Kg", "Cây"]']);
  }
}

function getAllData(ss) {
  var tSheet = ss.getSheetByName('Transactions');
  var sSheet = ss.getSheetByName('Settings');
  
  var tData = tSheet.getDataRange().getValues();
  var sData = sSheet.getDataRange().getValues();
  
  var budget = 0;
  var backgroundImage = "";
  var adminUser = "admin";
  var adminPass = "Voi123";
  var suppliers = ["Xuân Chí"];
  var materials = ["Cát", "Đá", "Xi măng"];
  var units = ["m3", "Xe", "Bao", "Kg"];

  // Đọc settings
  for(var i=1; i<sData.length; i++) {
    var key = String(sData[i][0]);
    var val = sData[i][1];
    if(key == 'budget') budget = val;
    if(key == 'background_image') backgroundImage = val;
    if(key == 'admin_user') adminUser = String(val); 
    if(key == 'admin_pass') adminPass = String(val);
    if(key == 'suppliers_list') { try { suppliers = JSON.parse(val); } catch(e) {} }
    if(key == 'materials_list') { try { materials = JSON.parse(val); } catch(e) {} }
    if(key == 'units_list') { try { units = JSON.parse(val); } catch(e) {} }
  }

  // Map transactions
  // Column mapping (0-based index):
  // 0:id, 1:date, 2:amount, 3:type, 4:cat, 5:desc, 6:img, 7:qty, 8:unit (NEW), 9:price, 10:supplier, 11:paid
  // Note: Nếu sheet cũ chưa có cột unit ở giữa, logic này có thể bị lệch. 
  // Để an toàn cho dữ liệu cũ, ta sẽ check độ dài row.
  
  var transactions = tData.slice(1).map(function(r) {
    // Basic fields always present
    var item = { 
      id: String(r[0]), 
      date: String(r[1]).replace(/'/g, ''), 
      amount: Number(r[2]), 
      type: r[3], 
      category: r[4], 
      description: r[5],
      image: r[6] || '',
      quantity: r[7] ? Number(r[7]) : null
    };

    // Handle variable columns based on row length to support old data structure migration
    // Old structure length usually around 11 (last index 10). New is 12.
    if (r.length >= 12) {
       // New structure
       item.unit = r[8] ? String(r[8]) : '';
       item.unitPrice = r[9] ? Number(r[9]) : null;
       item.supplier = r[10] ? String(r[10]) : '';
       item.isPaid = r[11] === true || r[11] === 'TRUE' || r[11] === true;
    } else {
       // Old structure fallback (assuming unit didn't exist)
       // 0-7 same. 8:price, 9:supplier, 10:paid
       item.unit = ''; 
       item.unitPrice = r[8] ? Number(r[8]) : null;
       item.supplier = r[9] ? String(r[9]) : '';
       item.isPaid = r[10] === true || r[10] === 'TRUE' || r[10] === true;
    }
    
    return item;
  });

  return {
    budget: Number(budget),
    backgroundImage: backgroundImage,
    adminUser: adminUser,
    adminPass: adminPass,
    suppliers: suppliers,
    materials: materials,
    units: units,
    transactions: transactions
  };
}

function deleteRow(sheet, id) {
  var data = sheet.getDataRange().getValues();
  for (var i = 1; i < data.length; i++) {
    if (String(data[i][0]) === String(id)) {
      sheet.deleteRow(i + 1);
      return;
    }
  }
}

function saveTransaction(ss, data) {
  var sheet = ss.getSheetByName('Transactions');
  var allData = sheet.getDataRange().getValues();
  
  // Force structure: 
  // 0:id, 1:date, 2:amount, 3:type, 4:cat, 5:desc, 6:img, 7:qty, 8:unit, 9:price, 10:supplier, 11:paid
  var row = [
    data.id, 
    "'" + data.date, 
    data.amount, 
    data.type, 
    data.category, 
    data.description, 
    data.image || '', 
    data.quantity || '',
    data.unit || '', 
    data.unitPrice || '',
    data.supplier || '',
    data.isPaid === true ? 'TRUE' : 'FALSE'
  ];
  
  for (var i = 1; i < allData.length; i++) {
    if (String(allData[i][0]) === String(data.id)) {
      sheet.getRange(i + 1, 1, 1, row.length).setValues([row]);
      return;
    }
  }
  sheet.appendRow(row);
}

function updateSetting(ss, key, val) {
  var sheet = ss.getSheetByName('Settings');
  var data = sheet.getDataRange().getValues();
  var found = false;
  for(var i=1; i<data.length; i++) {
    if(String(data[i][0]) === String(key)) {
      sheet.getRange(i+1, 2).setValue(val);
      found = true;
      break;
    }
  }
  if (!found) {
    sheet.appendRow([key, val]);
  }
}