// --- ĐÂY LÀ CODE DÀNH CHO GOOGLE APPS SCRIPT (FILE .gs) ---
// HƯỚNG DẪN:
// 1. Xóa toàn bộ code cũ trong file Mã.gs (Code.gs)
// 2. Dán code này vào.
// 3. Bấm nút "Deploy" (Triển khai) -> "New Deployment" (Bài triển khai mới).
// 4. Chọn loại: "Web App".
// 5. Phần "Who has access" (Ai có quyền truy cập): CHỌN "ANYONE" (BẤT KỲ AI).
// 6. Bấm Deploy.

function doGet(e) {
  return handleRequest(e);
}

function doPost(e) {
  return handleRequest(e);
}

function handleRequest(e) {
  var lock = LockService.getScriptLock();
  var isWriteAction = e && e.parameter && e.parameter.action && e.parameter.action !== 'get_data';
  
  if (isWriteAction) {
    lock.tryLock(10000); 
  }

  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    setupSheets(ss);

    var action = '';
    var data = {};

    if (e.postData && e.postData.contents) {
      try {
        var json = JSON.parse(e.postData.contents);
        action = json.action;
        data = json.data;
      } catch (err) {}
    } else if (e.parameter) {
      action = e.parameter.action;
      if (e.parameter.data) {
        try { data = JSON.parse(e.parameter.data); } catch (err) {}
      }
    }

    var result = {};
    
    if (action === 'get_data' || !action) {
      result = getAllData(ss);
    } 
    else if (action === 'save_transaction') {
      saveTransaction(ss, data);
      result = { status: 'success' };
    }
    else if (action === 'delete_transaction') {
      deleteRow(ss.getSheetByName('Transactions'), data.id);
      result = { status: 'success' };
    }
    else if (action === 'save_material') {
      saveMaterial(ss, data);
      result = { status: 'success' };
    }
    else if (action === 'delete_material') {
      deleteRow(ss.getSheetByName('Materials'), data.id);
      result = { status: 'success' };
    }
    else if (action === 'save_setting') {
      updateSetting(ss, data.key, data.value);
      result = { status: 'success' };
    }
    else if (action === 'update_budget') {
      updateSetting(ss, 'budget', data.amount);
      result = { status: 'success' };
    }

    return ContentService.createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  } finally {
    if (isWriteAction) lock.releaseLock();
  }
}

function setupSheets(ss) {
  if (!ss.getSheetByName('Transactions')) ss.insertSheet('Transactions').appendRow(['id', 'date', 'amount', 'type', 'category', 'description', 'image']);
  if (!ss.getSheetByName('Materials')) ss.insertSheet('Materials').appendRow(['id', 'name', 'unit', 'quantity', 'unitPrice', 'totalValue', 'supplier', 'lastUpdated', 'image']);
  if (!ss.getSheetByName('Settings')) {
    var sSheet = ss.insertSheet('Settings');
    sSheet.appendRow(['key', 'value']);
    // Khởi tạo giá trị mặc định nếu chưa có
    sSheet.appendRow(['budget', '0']);
    sSheet.appendRow(['admin_user', 'admin']);
    sSheet.appendRow(['admin_pass', 'Voi123']);
  }
}

function getAllData(ss) {
  var tSheet = ss.getSheetByName('Transactions');
  var mSheet = ss.getSheetByName('Materials');
  var sSheet = ss.getSheetByName('Settings');
  
  var tData = tSheet.getDataRange().getValues();
  var mData = mSheet.getDataRange().getValues();
  var sData = sSheet.getDataRange().getValues();
  
  var budget = 0;
  var backgroundImage = "";
  var adminUser = "admin";
  var adminPass = "Voi123";

  // Đọc settings
  for(var i=1; i<sData.length; i++) {
    var key = String(sData[i][0]);
    var val = sData[i][1];
    if(key == 'budget') budget = val;
    if(key == 'background_image') backgroundImage = val;
    if(key == 'admin_user') adminUser = String(val); // Ép kiểu string để tránh lỗi nếu nhập số
    if(key == 'admin_pass') adminPass = String(val);
  }

  return {
    budget: Number(budget),
    backgroundImage: backgroundImage,
    adminUser: adminUser,
    adminPass: adminPass,
    transactions: tData.slice(1).map(function(r) {
      return { 
        id: String(r[0]), 
        date: String(r[1]).replace(/'/g, ''), 
        amount: Number(r[2]), 
        type: r[3], 
        category: r[4], 
        description: r[5],
        image: r[6] || ''
      };
    }),
    materials: mData.slice(1).map(function(r) {
      return { 
        id: String(r[0]), 
        name: r[1], 
        unit: r[2], 
        quantity: Number(r[3]), 
        unitPrice: Number(r[4]), 
        totalValue: Number(r[5]), 
        supplier: r[6], 
        lastUpdated: String(r[7]).replace(/'/g, ''),
        image: r[8] || ''
      };
    })
  };
}

function deleteRow(sheet, id) {
  var data = sheet.getDataRange().getValues();
  for (var i = 1; i < data.length; i++) {
    if (String(data[i][0]) === String(id)) {
      sheet.deleteRow(i + 1);
      return;
    }
  }
}

function saveTransaction(ss, data) {
  var sheet = ss.getSheetByName('Transactions');
  var allData = sheet.getDataRange().getValues();
  var row = [data.id, "'" + data.date, data.amount, data.type, data.category, data.description, data.image || ''];
  
  for (var i = 1; i < allData.length; i++) {
    if (String(allData[i][0]) === String(data.id)) {
      sheet.getRange(i + 1, 1, 1, row.length).setValues([row]);
      return;
    }
  }
  sheet.appendRow(row);
}

function saveMaterial(ss, data) {
  var sheet = ss.getSheetByName('Materials');
  var allData = sheet.getDataRange().getValues();
  var row = [data.id, data.name, data.unit, data.quantity, data.unitPrice, data.totalValue, data.supplier, "'" + data.lastUpdated, data.image || ''];
  
  for (var i = 1; i < allData.length; i++) {
    if (String(allData[i][0]) === String(data.id)) {
      sheet.getRange(i + 1, 1, 1, row.length).setValues([row]);
      return;
    }
  }
  sheet.appendRow(row);
}

function updateSetting(ss, key, val) {
  var sheet = ss.getSheetByName('Settings');
  var data = sheet.getDataRange().getValues();
  var found = false;
  for(var i=1; i<data.length; i++) {
    if(String(data[i][0]) === String(key)) {
      sheet.getRange(i+1, 2).setValue(val);
      found = true;
      break;
    }
  }
  if (!found) {
    sheet.appendRow([key, val]);
  }
}